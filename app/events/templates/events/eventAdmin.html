{% extends 'base.html' %}

{% block title %}Admin{% endblock %}

{% block content %}
<div class="events-container">
    <h1 class="title">Admin Dashboard</h1>

    <div class="section">
        <div class="header">Manage Events</div>
        <div class="header-2">Approved Events</div>
        <div class="list">
            {% if events %}
                {% for event in events %}
                {% if event['status'] == 'approved' %}
                <div class="resource">
                    <div>
                        <span class="event-link" 
                              data-name="{{ event['name'] }}" 
                              data-start="{{ event['start'].strftime('%b %d, %Y %I:%M %p') }}"
                              data-end="{{ event['end'].strftime('%b %d, %Y %I:%M %p') }}"
                              data-description="{{ event['description'] }}"
                              data-deadline="{{ event['registration_deadline'].strftime('%b %d, %Y %I:%M %p') if event['registration_deadline'] else 'N/A' }}"
                              data-url="{{ event['url'] or '' }}"
                              data-status="{{ event['status'] if event['status'] else 'pending' }}">
                            {{ event['name'] }}
                        </span><br>
                        <small>{{ event['start'].strftime('%b %d, %Y %I:%M %p') }} – {{ event['end'].strftime('%b %d, %Y %I:%M %p') }}</small><br>
                        <p>{{ event['description'] }}</p>
                        <div class="status">
                            Status: {{ event['status'] if event['status'] else 'pending' }}
                        </div>
                    </div>
                    <div class="actions">
                        <a href="{{ url_for('events.update_event', event_id=event['event_id'], action='approved') }}">
                            <button class="btn btn-approve">Approve</button>
                        </a>
                        <a href="{{ url_for('events.update_event', event_id=event['event_id'], action='cancelled') }}">
                            <button class="btn btn-reject">Reject/Cancel</button>
                        </a>
                        <a href="{{ url_for('events.edit_event', event_id=event['event_id']) }}">
                            <button class="btn btn-edit">Edit</button>
                        </a>
                        <form method="POST" action="{{ url_for('events.delete_event', event_id=event['event_id']) }}" onsubmit="return confirm('Delete this event?');" style="display:inline;">
                            <button type="submit" class="btn btn-reject">Delete</button>
                        </form>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <div class="resource">No events found in the database.</div>
            {% endif %}
        </div>

        <div class="header-2">Cancelled Events</div>
        <div class="list">
            {% if events %}
                {% for event in events %}
                {% if event['status'] == 'cancelled' %}
                <div class="resource">
                    <div>
                        <span class="event-link" 
                              data-name="{{ event['name'] }}" 
                              data-start="{{ event['start'].strftime('%b %d, %Y %I:%M %p') }}"
                              data-end="{{ event['end'].strftime('%b %d, %Y %I:%M %p') }}"
                              data-description="{{ event['description'] }}"
                              data-deadline="{{ event['registration_deadline'].strftime('%b %d, %Y %I:%M %p') if event['registration_deadline'] else 'N/A' }}"
                              data-url="{{ event['url'] or '' }}"
                              data-status="{{ event['status'] if event['status'] else 'pending' }}">
                            {{ event['name'] }}
                        </span><br>
                        <small>{{ event['start'].strftime('%b %d, %Y %I:%M %p') }} – {{ event['end'].strftime('%b %d, %Y %I:%M %p') }}</small><br>
                        <p>{{ event['description'] }}</p>
                        <div class="status">
                            Status: {{ event['status'] if event['status'] else 'pending' }}
                        </div>
                    </div>
                    <div class="actions">
                        <a href="{{ url_for('events.update_event', event_id=event['event_id'], action='approved') }}">
                            <button class="btn btn-approve">Approve</button>
                        </a>
                        <a href="{{ url_for('events.update_event', event_id=event['event_id'], action='cancelled') }}">
                            <button class="btn btn-reject">Reject/Cancel</button>
                        </a>
                        <a href="{{ url_for('events.edit_event', event_id=event['event_id']) }}">
                            <button class="btn btn-edit">Edit</button>
                        </a>
                        <form method="POST" action="{{ url_for('events.delete_event', event_id=event['event_id']) }}" onsubmit="return confirm('Delete this event?');" style="display:inline;">
                            <button type="submit" class="btn btn-reject">Delete</button>
                        </form>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <div class="resource">No events found in the database.</div>
            {% endif %}
        </div>

        <div class="header-2">Pending Events</div>
        <div class="list">
            {% if events %}
                {% for event in events %}
                {% if event['status'] == 'pending' or not event['status'] %}
                <div class="resource">
                    <div>
                        <span class="event-link" 
                              data-name="{{ event['name'] }}" 
                              data-start="{{ event['start'].strftime('%b %d, %Y %I:%M %p') }}"
                              data-end="{{ event['end'].strftime('%b %d, %Y %I:%M %p') }}"
                              data-description="{{ event['description'] }}"
                              data-deadline="{{ event['registration_deadline'].strftime('%b %d, %Y %I:%M %p') if event['registration_deadline'] else 'N/A' }}"
                              data-url="{{ event['url'] or '' }}"
                              data-status="{{ event['status'] if event['status'] else 'pending' }}">
                            {{ event['name'] }}
                        </span><br>
                        <small>{{ event['start'].strftime('%b %d, %Y %I:%M %p') }} – {{ event['end'].strftime('%b %d, %Y %I:%M %p') }}</small><br>
                        <p>{{ event['description'] }}</p>
                        <div class="status">
                            Status: {{ event['status'] if event['status'] else 'pending' }}
                        </div>
                    </div>
                    <div class="actions">
                        <a href="{{ url_for('events.update_event', event_id=event['event_id'], action='approved') }}">
                            <button class="btn btn-approve">Approve</button>
                        </a>
                        <a href="{{ url_for('events.update_event', event_id=event['event_id'], action='cancelled') }}">
                            <button class="btn btn-reject">Reject/Cancel</button>
                        </a>
                        <a href="{{ url_for('events.edit_event', event_id=event['event_id']) }}">
                            <button class="btn btn-edit">Edit</button>
                        </a>
                        <form method="POST" action="{{ url_for('events.delete_event', event_id=event['event_id']) }}" onsubmit="return confirm('Delete this event?');" style="display:inline;">
                            <button type="submit" class="btn btn-reject">Delete</button>
                        </form>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <div class="resource">No events found in the database.</div>
            {% endif %}
        </div>
    </div>
</div>

<div id="overlay"></div>
<div id="eventPopup">
    <span id="eventPopupClose">X</span>
    <h3 id="popupEventName"></h3>
    <p><strong>Start:</strong> <span id="popupEventStart"></span></p>
    <p><strong>End:</strong> <span id="popupEventEnd"></span></p>
    <p><strong>Registration Deadline:</strong> <span id="popupEventDeadline"></span></p>
    <p><strong>URL:</strong> <span id="popupEventURL"></span></p>
    <p id="popupEventDescription"></p>
    <p><strong>Status:</strong> <span id="popupEventStatus"></span></p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('eventPopup');
    const overlay = document.getElementById('overlay');
    const popupClose = document.getElementById('eventPopupClose');
    const popupName = document.getElementById('popupEventName');
    const popupStart = document.getElementById('popupEventStart');
    const popupEnd = document.getElementById('popupEventEnd');
    const popupDeadline = document.getElementById('popupEventDeadline');
    const popupURL = document.getElementById('popupEventURL');
    const popupDescription = document.getElementById('popupEventDescription');
    const popupStatus = document.getElementById('popupEventStatus');

    document.querySelectorAll('.event-link').forEach(link => {
        link.addEventListener('click', function() {
            const name = this.getAttribute('data-name');
            const description = this.getAttribute('data-description') || "No description available.";
            popupStart.textContent = this.dataset.start;
            popupEnd.textContent = this.dataset.end;
            popupDeadline.textContent = this.dataset.deadline;
            popupStatus.textContent = this.dataset.status;
            popupName.textContent = name;
            popupDescription.textContent = description;
            popup.style.display = 'block';
            overlay.style.display = 'block';
            const url = this.dataset.url;
            if (url) {
                popupURL.innerHTML = `<a href="${url}" target="_blank" class="link">${url}</a>`;
            } else {
                popupURL.textContent = 'N/A';
            }
        });
    });

    popupClose.addEventListener('click', function() {
        popup.style.display = 'none';
        overlay.style.display = 'none';
    });

    overlay.addEventListener('click', function() {
        popup.style.display = 'none';
        overlay.style.display = 'none';
    });
});
</script>
{% endblock %}
