{% extends 'base.html' %}

{% block title %}Calendar{% endblock %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/lux/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

<style>
#calendar {
  max-width: 900px;
  margin: 50px auto;                  
  background: #ffffff;
  padding: 30px;
  border-radius: 20px;
  box-shadow: 0 10px 15px rgb(122, 224, 81);
}
.fc-toolbar-title {
  color: #2a4468;                    
  font-weight: 800;
}

.fc-button-primary {
  background-color: #3a6ea5 !important;
  border-color: #3a6ea5 !important;
  color: #fff !important;
}
.fc-button-primary:hover,
.fc-button-primary:focus {
  background-color: #315c88 !important;
  border-color: #315c88 !important;
}

.fc-day-today {
  background: #aaeb54  !important;
}
.fc-daygrid-day:hover {
  background-color: #e8f1ff !important;  
  cursor: pointer;
}

.fc-event {
  background-color: #3a6ea4 !important; 
  border: none !important;
  color: #fff !important;
  border-radius: 6px;
  padding: 2px 6px;
  font-weight: 600;
}

.fc-daygrid-day-frame {
  padding: 6px !important;
}

body {
  background-color: #f7f9fc;
}

#eventPopup {
  display: none;
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, 0);
  background: white;
  border: 2px solid #333;
  padding: 20px;
  z-index: 1000;
  max-width: 400px;
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0,0,0,1);
}
#eventPopupClose {
  cursor: pointer;
  float: right;
  font-weight: bold;
}
#overlay {
  display: none;
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.3);
}

.link {
  cursor: pointer;
}

.add-event a {
  background-color: #aaeb54;
  font-weight: bold;
}
</style>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const popup = document.getElementById('eventPopup');
  const overlay = document.getElementById('overlay');
  const filterSelect = document.getElementById('contentTypeFilter');

  let allEvents = []; 

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    themeSystem: 'standard',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek,multiMonthYear'
    },
    views: { listWeek: { buttonText: 'list' } },
    contentHeight: 'auto',
    events: [], 
    eventClick: function(info) {
      popup.innerHTML = `
        <span id="eventPopupClose">X</span>
        <h3>${info.event.title}</h3>
        <p><strong>Start:</strong> ${info.event.start.toLocaleString()}</p>
        <p><strong>End:</strong> ${info.event.end.toLocaleString()}</p>
        <p><strong>Registration Deadline:</strong> ${info.event.extendedProps.registration_deadline 
        ? new Date(info.event.extendedProps.registration_deadline).toLocaleString() 
        : 'N/A'}</p>
        <p><strong>Description:</strong> ${info.event.extendedProps.description || "N/A"}</p>
        <p><strong>URL:</strong> <a href="${info.event.url}" classname="link" target="_blank">${info.event.url || "N/A"}</a></p>
      `;
      popup.style.display = 'block';
      overlay.style.display = 'block'; 
      info.jsEvent.preventDefault();

      document.getElementById('eventPopupClose').onclick = function() {
        popup.style.display = 'none';
        overlay.style.display = 'none';
      };
      overlay.onclick = function() {
        popup.style.display = 'none';
        overlay.style.display = 'none';
      };
    }
  });

  fetch('/approved-events')
    .then(res => res.json())
    .then(data => {
      allEvents = data;
      calendar.addEventSource(allEvents);
      
      // Check if an event was passed as a query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const eventParam = urlParams.get('event');
      
      if (eventParam) {
        // Find the event with matching title
        const targetEvent = allEvents.find(e => e.title === decodeURIComponent(eventParam));
        if (targetEvent) {
          // Wait a moment for the calendar to render, then show the popup
          setTimeout(() => {
            popup.innerHTML = `
              <span id="eventPopupClose">X</span>
              <h3>${targetEvent.title}</h3>
              <p><strong>Start:</strong> ${new Date(targetEvent.start).toLocaleString()}</p>
              <p><strong>End:</strong> ${new Date(targetEvent.end).toLocaleString()}</p>
              <p><strong>Registration Deadline:</strong> ${targetEvent.registration_deadline 
              ? new Date(targetEvent.registration_deadline).toLocaleString() 
              : 'N/A'}</p>
              <p><strong>Description:</strong> ${targetEvent.description || "N/A"}</p>
              <p><strong>URL:</strong> <a href="${targetEvent.url}" class="link" target="_blank">${targetEvent.url || "N/A"}</a></p>
            `;
            popup.style.display = 'block';
            overlay.style.display = 'block';
            
            document.getElementById('eventPopupClose').onclick = function() {
              popup.style.display = 'none';
              overlay.style.display = 'none';
            };
            overlay.onclick = function() {
              popup.style.display = 'none';
              overlay.style.display = 'none';
            };
          }, 500);
        }
      }
    })
    .catch(err => console.error(err));

  filterSelect.addEventListener('change', function() {
    const selectedType = filterSelect.value;

    const filteredEvents = selectedType
      ? allEvents.filter(e => String(e.content_type) === selectedType)
      : allEvents;

    calendar.removeAllEvents();
    calendar.addEventSource(filteredEvents);
  });

  calendar.render();
});
</script>
{% endblock %}


{% block content %}
<div class="add-event d-flex justify-content-between align-items-center m-3">
  <div class="mb-3 mt-3">
    <label for="contentTypeFilter">Content Type:</label>
    <select id="contentTypeFilter" class="form-select d-inline-block w-auto">
      <option value="">All</option>
      <option value="1">Worship</option>
      <option value="2">Retreat</option>
      <option value="3">Training</option>
      <option value="4">Service</option>
      <option value="5">Meeting</option>
    </select>
  </div>

  <a href="/add-event" class="button">
    Add Event
  </a>
</div>

<div id="calendar"></div>
<div id="overlay"></div>
<div id="eventPopup"></div>
{% endblock %}